<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass House - $OPEN Intelligence Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --accent-blue: #3b82f6;
            --border-color: #27272a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'SF Pro Display', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff 0%, #a1a1aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .header .stock-price {
            margin-top: 15px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .kpi-card .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .kpi-card .change {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .kpi-card.positive .value { color: var(--accent-green); }
        .kpi-card.negative .value { color: var(--accent-red); }
        .kpi-card.warning .value { color: var(--accent-yellow); }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title .icon {
            font-size: 1.5rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .chart-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .kaz-era-banner {
            background: linear-gradient(135deg, #1a472a 0%, #0f2818 100%);
            border: 1px solid #22c55e33;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }

        .kaz-section {
            text-align: center;
        }

        .kaz-section .title {
            color: #86efac;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .kaz-section .big-number {
            font-size: 3rem;
            font-weight: 700;
            color: #22c55e;
        }

        .kaz-section .detail {
            color: #86efac;
            font-size: 0.95rem;
            margin-top: 5px;
        }

        .cohort-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .cohort-table th, .cohort-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .cohort-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .cohort-table tr:hover {
            background: var(--bg-secondary);
        }

        .win-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .win-badge.high { background: #22c55e22; color: #22c55e; }
        .win-badge.medium { background: #eab30822; color: #eab308; }
        .win-badge.low { background: #ef444422; color: #ef4444; }

        .progress-bar {
            background: var(--bg-secondary);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-label {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .market-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .market-card .state {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .market-card .count {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .alert-banner {
            background: #ef444422;
            border: 1px solid #ef444444;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-banner .icon { font-size: 1.2rem; }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .timestamp {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .kaz-era-banner {
                grid-template-columns: 1fr;
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GLASS HOUSE</h1>
        <div class="subtitle">$OPEN Operational Intelligence Dashboard</div>
        <div class="stock-price" id="stockPrice">Loading...</div>
    </div>

    <div id="alertBanner"></div>

    <!-- Kaz-Era Banner -->
    <div class="kaz-era-banner" id="kazEraBanner">
        <div class="kaz-section">
            <div class="title">Realized (Sold)</div>
            <div class="big-number" id="kazSoldWin">--</div>
            <div class="detail" id="kazSoldDetail">-- profitable</div>
        </div>
        <div class="kaz-section">
            <div class="title">Unrealized (On Market)</div>
            <div class="big-number" id="kazMarketWin">--</div>
            <div class="detail" id="kazMarketDetail">-- above water</div>
        </div>
        <div class="kaz-section">
            <div class="title">vs Legacy</div>
            <div class="big-number" id="kazImprovement">--</div>
            <div class="detail">Kaz-Era Performance</div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-row" id="kpiRow">
        <div class="kpi-card">
            <div class="label">Win Rate</div>
            <div class="value" id="kpiWinRate">--</div>
        </div>
        <div class="kpi-card">
            <div class="label">Q1 Revenue</div>
            <div class="value" id="kpiRevenue">--</div>
        </div>
        <div class="kpi-card">
            <div class="label">Homes Sold</div>
            <div class="value" id="kpiSold">--</div>
        </div>
        <div class="kpi-card">
            <div class="label">Inventory</div>
            <div class="value" id="kpiInventory">--</div>
        </div>
        <div class="kpi-card">
            <div class="label">Toxic Remaining</div>
            <div class="value" id="kpiToxic">--</div>
        </div>
    </div>

    <!-- Q1 Guidance -->
    <div class="section">
        <div class="section-title"><span class="icon">üìä</span> Q1 2026 Guidance Progress</div>
        <div class="chart-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>$<span id="guidanceRevenue">0</span>M of $595M</span>
                <span id="guidancePct">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="guidanceBar" style="width: 0%; background: linear-gradient(90deg, #22c55e, #3b82f6);"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;">
                <span>Projected: $<span id="guidanceProjected">0</span>M</span>
                <span id="guidancePace">--</span>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="section">
        <div class="section-title"><span class="icon">üìà</span> Historical Trends</div>
        <div class="chart-grid">
            <div class="chart-card">
                <h3>Win Rate Over Time</h3>
                <div id="chartWinRate"></div>
            </div>
            <div class="chart-card">
                <h3>Kaz-Era Health</h3>
                <div id="chartKazEra"></div>
            </div>
            <div class="chart-card">
                <h3>Revenue Accumulation</h3>
                <div id="chartRevenue"></div>
            </div>
            <div class="chart-card">
                <h3>Toxic Countdown</h3>
                <div id="chartToxic"></div>
            </div>
        </div>
    </div>

    <!-- Cohorts -->
    <div class="section">
        <div class="section-title"><span class="icon">üìã</span> Cohort Performance</div>
        <div class="chart-card">
            <table class="cohort-table">
                <thead>
                    <tr>
                        <th>Cohort</th>
                        <th>Count</th>
                        <th>Win Rate</th>
                        <th>Avg Profit</th>
                        <th>Margin</th>
                    </tr>
                </thead>
                <tbody id="cohortTable">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cohort Chart -->
    <div class="section">
        <div class="chart-grid">
            <div class="chart-card">
                <h3>Cohort Win Rates</h3>
                <div id="chartCohorts"></div>
            </div>
            <div class="chart-card">
                <h3>Inventory Aging</h3>
                <div id="chartInventory"></div>
            </div>
        </div>
    </div>

    <!-- Markets -->
    <div class="section">
        <div class="section-title"><span class="icon">üó∫Ô∏è</span> Market Distribution</div>
        <div class="chart-card">
            <div id="chartMarkets"></div>
        </div>
    </div>

    <div class="timestamp" id="timestamp">Last updated: --</div>

    <script>
        // Plotly dark theme
        const plotlyLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#a1a1aa', family: '-apple-system, BlinkMacSystemFont, sans-serif' },
            margin: { t: 20, r: 20, b: 40, l: 50 },
            xaxis: {
                gridcolor: '#27272a',
                linecolor: '#27272a',
            },
            yaxis: {
                gridcolor: '#27272a',
                linecolor: '#27272a',
            },
        };

        const colors = {
            green: '#22c55e',
            red: '#ef4444',
            yellow: '#eab308',
            blue: '#3b82f6',
            purple: '#a855f7',
        };

        // Load data
        async function loadData() {
            try {
                // Try to load from outputs directory
                const response = await fetch('outputs/dashboard_data.json');
                if (!response.ok) throw new Error('Data not found');
                return await response.json();
            } catch (e) {
                console.log('Loading sample data...');
                return getSampleData();
            }
        }

        function getSampleData() {
            // Sample data structure - will be replaced by real data
            return {
                current: {
                    date: "2026-01-27",
                    stock_price: 5.87,
                    performance: {
                        win_rate: 68.7,
                        homes_sold_total: 319,
                        revenue_total: 119653700,
                        contribution_margin: 7.02,
                    },
                    inventory: {
                        total: 764,
                        fresh_count: 54,
                        normal_count: 91,
                        stale_count: 164,
                        very_stale_count: 371,
                        toxic_count: 84,
                    },
                    cohort_new: { count: 72, win_rate: 90.3, avg_profit: 40700, contribution_margin: 10.4 },
                    cohort_mid: { count: 104, win_rate: 84.6, avg_profit: 36900, contribution_margin: 10.0 },
                    cohort_old: { count: 100, win_rate: 53.0, avg_profit: 21700, contribution_margin: 5.4 },
                    cohort_toxic: { count: 43, win_rate: 30.2, avg_profit: -12500, contribution_margin: -4.1 },
                    toxic: { sold_count: 43, remaining_count: 84, clearance_pct: 33.9 },
                    kaz_era: {
                        realized: { count: 43, profitable: 41, win_rate: 95.3, avg_profit: 43200 },
                        unrealized: { count: 103, above_water: 100, above_water_pct: 97.1, underwater: 3 },
                        total: 146,
                        overall_health_pct: 96.6,
                        vs_legacy_improvement: 31,
                    },
                    guidance: {
                        q1_target: 595000000,
                        revenue_to_date: 119653700,
                        pct_to_target: 20.1,
                        projected_quarter_revenue: 409580000,
                        pace_vs_required: "behind",
                    },
                    alerts: ["New cohort win rate dropped to 90.3% (target: >95%)"],
                },
                history: [],
            };
        }

        function formatCurrency(val, short = true) {
            if (val >= 1000000000) return '$' + (val / 1000000000).toFixed(2) + 'B';
            if (val >= 1000000) return '$' + (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return '$' + (val / 1000).toFixed(1) + 'K';
            return '$' + val.toFixed(0);
        }

        function getWinBadge(rate) {
            if (rate >= 90) return `<span class="win-badge high">${rate.toFixed(1)}%</span>`;
            if (rate >= 70) return `<span class="win-badge medium">${rate.toFixed(1)}%</span>`;
            return `<span class="win-badge low">${rate.toFixed(1)}%</span>`;
        }

        function renderDashboard(data) {
            const d = data.current;

            // Stock price
            document.getElementById('stockPrice').innerHTML = `$OPEN: $${d.stock_price?.toFixed(2) || '5.87'}`;

            // Alerts
            if (d.alerts && d.alerts.length > 0) {
                document.getElementById('alertBanner').innerHTML = d.alerts.map(a =>
                    `<div class="alert-banner"><span class="icon">‚ö†Ô∏è</span> ${a}</div>`
                ).join('');
            }

            // Kaz-Era Banner
            const kaz = d.kaz_era || {};
            document.getElementById('kazSoldWin').textContent = `${kaz.realized?.win_rate?.toFixed(1) || 0}%`;
            document.getElementById('kazSoldDetail').textContent = `${kaz.realized?.profitable || 0}/${kaz.realized?.count || 0} profitable`;
            document.getElementById('kazMarketWin').textContent = `${kaz.unrealized?.above_water_pct?.toFixed(1) || 0}%`;
            document.getElementById('kazMarketDetail').textContent = `${kaz.unrealized?.above_water || 0}/${kaz.unrealized?.count || 0} above water`;
            document.getElementById('kazImprovement').textContent = `+${kaz.vs_legacy_improvement || 0}pp`;

            // KPIs
            document.getElementById('kpiWinRate').textContent = `${d.performance?.win_rate?.toFixed(1) || 0}%`;
            document.getElementById('kpiRevenue').textContent = formatCurrency(d.performance?.revenue_total || 0);
            document.getElementById('kpiSold').textContent = d.performance?.homes_sold_total || 0;
            document.getElementById('kpiInventory').textContent = d.inventory?.total || 0;
            document.getElementById('kpiToxic').textContent = d.toxic?.remaining_count || 0;

            // Guidance
            const g = d.guidance || {};
            const revM = (g.revenue_to_date || 0) / 1000000;
            const projM = (g.projected_quarter_revenue || 0) / 1000000;
            document.getElementById('guidanceRevenue').textContent = revM.toFixed(1);
            document.getElementById('guidancePct').textContent = `${g.pct_to_target?.toFixed(1) || 0}%`;
            document.getElementById('guidanceBar').style.width = `${Math.min(g.pct_to_target || 0, 100)}%`;
            document.getElementById('guidanceProjected').textContent = projM.toFixed(0);
            const paceEmoji = g.pace_vs_required === 'ahead' ? 'üü¢' : g.pace_vs_required === 'on_track' ? 'üü°' : 'üî¥';
            document.getElementById('guidancePace').textContent = `${paceEmoji} ${(g.pace_vs_required || 'unknown').toUpperCase()}`;

            // Cohort Table
            const cohorts = [
                { name: 'NEW (<90d)', data: d.cohort_new, signal: true },
                { name: 'MID (90-180d)', data: d.cohort_mid },
                { name: 'OLD (180-365d)', data: d.cohort_old },
                { name: 'TOXIC (>365d)', data: d.cohort_toxic, toxic: true },
            ];
            document.getElementById('cohortTable').innerHTML = cohorts.map(c => `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.data?.count || 0}</td>
                    <td>${getWinBadge(c.data?.win_rate || 0)}</td>
                    <td>${formatCurrency(c.data?.avg_profit || 0)}</td>
                    <td>${(c.data?.contribution_margin || 0).toFixed(1)}%</td>
                </tr>
            `).join('');

            // Timestamp
            document.getElementById('timestamp').textContent = `Last updated: ${d.date || new Date().toISOString().split('T')[0]}`;

            // Render charts
            renderCharts(data);
        }

        function renderCharts(data) {
            const history = data.history || [];
            const current = data.current;

            // Win Rate Chart
            if (history.length > 1) {
                const dates = history.map(h => h.date);
                const winRates = history.map(h => h.performance?.win_rate || 0);
                const newCohortRates = history.map(h => h.cohort_new?.win_rate || 0);

                Plotly.newPlot('chartWinRate', [
                    { x: dates, y: winRates, name: 'Overall', line: { color: colors.blue, width: 2 } },
                    { x: dates, y: newCohortRates, name: 'New Cohort', line: { color: colors.green, width: 2 } },
                ], { ...plotlyLayout, showlegend: true, legend: { x: 0, y: 1.1, orientation: 'h' } }, { responsive: true });
            } else {
                document.getElementById('chartWinRate').innerHTML = '<p style="text-align:center;color:#666;padding:50px;">Run daily to accumulate history</p>';
            }

            // Kaz-Era Chart
            if (history.length > 1) {
                const dates = history.map(h => h.date);
                const kazHealth = history.map(h => h.kaz_era?.overall_health_pct || 0);
                const kazSold = history.map(h => h.kaz_era?.realized?.win_rate || 0);

                Plotly.newPlot('chartKazEra', [
                    { x: dates, y: kazHealth, name: 'Overall Health', line: { color: colors.green, width: 3 } },
                    { x: dates, y: kazSold, name: 'Sold Win Rate', line: { color: colors.blue, width: 2, dash: 'dot' } },
                ], { ...plotlyLayout, showlegend: true, legend: { x: 0, y: 1.1, orientation: 'h' } }, { responsive: true });
            } else {
                // Show current as bar chart
                const kaz = current.kaz_era || {};
                Plotly.newPlot('chartKazEra', [{
                    type: 'bar',
                    x: ['Sold Win Rate', 'On Market Above Water', 'Overall Health'],
                    y: [kaz.realized?.win_rate || 0, kaz.unrealized?.above_water_pct || 0, kaz.overall_health_pct || 0],
                    marker: { color: [colors.green, colors.blue, colors.purple] },
                }], { ...plotlyLayout, yaxis: { ...plotlyLayout.yaxis, range: [0, 100] } }, { responsive: true });
            }

            // Revenue Chart
            if (history.length > 1) {
                const dates = history.map(h => h.date);
                const revenue = history.map(h => (h.performance?.revenue_total || 0) / 1000000);

                Plotly.newPlot('chartRevenue', [{
                    x: dates,
                    y: revenue,
                    fill: 'tozeroy',
                    fillcolor: 'rgba(34, 197, 94, 0.2)',
                    line: { color: colors.green, width: 2 },
                }], { ...plotlyLayout, yaxis: { ...plotlyLayout.yaxis, title: 'Revenue ($M)' } }, { responsive: true });
            } else {
                document.getElementById('chartRevenue').innerHTML = '<p style="text-align:center;color:#666;padding:50px;">Run daily to accumulate history</p>';
            }

            // Toxic Countdown
            const toxic = current.toxic || {};
            Plotly.newPlot('chartToxic', [{
                type: 'pie',
                values: [toxic.sold_count || 0, toxic.remaining_count || 0],
                labels: ['Cleared', 'Remaining'],
                marker: { colors: [colors.green, colors.red] },
                hole: 0.6,
                textinfo: 'value',
            }], {
                ...plotlyLayout,
                annotations: [{
                    text: `${toxic.clearance_pct?.toFixed(0) || 0}%`,
                    showarrow: false,
                    font: { size: 24, color: '#fff' },
                }],
            }, { responsive: true });

            // Cohort Bar Chart
            const cohortData = [
                { name: 'New', rate: current.cohort_new?.win_rate || 0 },
                { name: 'Mid', rate: current.cohort_mid?.win_rate || 0 },
                { name: 'Old', rate: current.cohort_old?.win_rate || 0 },
                { name: 'Toxic', rate: current.cohort_toxic?.win_rate || 0 },
            ];
            Plotly.newPlot('chartCohorts', [{
                type: 'bar',
                x: cohortData.map(c => c.name),
                y: cohortData.map(c => c.rate),
                marker: {
                    color: cohortData.map(c => c.rate >= 90 ? colors.green : c.rate >= 70 ? colors.yellow : colors.red),
                },
            }], { ...plotlyLayout, yaxis: { ...plotlyLayout.yaxis, range: [0, 100], title: 'Win Rate %' } }, { responsive: true });

            // Inventory Pie
            const inv = current.inventory || {};
            Plotly.newPlot('chartInventory', [{
                type: 'pie',
                values: [inv.fresh_count, inv.normal_count, inv.stale_count, inv.very_stale_count, inv.toxic_count],
                labels: ['Fresh (<60d)', 'Normal (60-120d)', 'Stale (120-180d)', 'Very Stale (180-365d)', 'Toxic (>365d)'],
                marker: { colors: [colors.green, colors.blue, colors.yellow, '#f97316', colors.red] },
            }], plotlyLayout, { responsive: true });

            // Markets Chart (simplified)
            const markets = [
                { state: 'NC', count: 127 },
                { state: 'GA', count: 102 },
                { state: 'TX', count: 89 },
                { state: 'FL', count: 85 },
                { state: 'SC', count: 61 },
                { state: 'AZ', count: 59 },
                { state: 'CA', count: 47 },
                { state: 'CO', count: 34 },
            ];
            Plotly.newPlot('chartMarkets', [{
                type: 'bar',
                x: markets.map(m => m.state),
                y: markets.map(m => m.count),
                marker: { color: colors.blue },
            }], { ...plotlyLayout, yaxis: { ...plotlyLayout.yaxis, title: 'Inventory Count' } }, { responsive: true });
        }

        // Initialize
        loadData().then(renderDashboard);

        // Auto-refresh every 5 minutes
        setInterval(() => loadData().then(renderDashboard), 300000);
    </script>
</body>
</html>
